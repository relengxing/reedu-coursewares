<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汽车上下坡问题 - 交互式动画</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(to bottom, #1a2980, #26d0ce);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .problem-description {
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .problem-description p {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .simulation-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .animation-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .animation-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .hill-scene {
            position: relative;
            width: 100%;
            height: 300px;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid #3498db;
        }

        .sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 70%;
            background: linear-gradient(to bottom, #1e90ff, #87ceeb);
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30%;
            background: linear-gradient(to top, #8bc34a, #7cb342);
        }

        .hill-svg-container {
            position: absolute;
            bottom: 30%;
            width: 100%;
            height: 200px;
        }

        .hill-svg {
            width: 100%;
            height: 100%;
        }

        .car {
            position: absolute;
            width: 80px;
            height: 40px;
            background: #e74c3c;
            border-radius: 10px 10px 0 0;
            transition: all 0.05s linear;
            z-index: 10;
            transform-origin: center center;
            /* 移除之前的 bottom 定位，改用 top 和 left */
            top: 0;
            left: 0;
        }

        .car-body {
            position: absolute;
            width: 100%;
            height: 70%;
            background: #e74c3c;
            border-radius: 10px 10px 0 0;
        }

        .car-top {
            position: absolute;
            top: 8px;
            left: 10px;
            width: 40px;
            height: 20px;
            background: #3498db;
            border-radius: 5px;
        }

        .wheel {
            position: absolute;
            bottom: -8px;
            width: 16px;
            height: 16px;
            background: #2c3e50;
            border-radius: 50%;
            border: 2px solid #7f8c8d;
        }

        .wheel.front {
            left: 15px;
        }

        .wheel.back {
            right: 15px;
        }

        .energy-display {
            position: absolute;
            right: 15px;
            top: 15px;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }

        .energy-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .energy-bar-container {
            margin-bottom: 15px;
        }

        .energy-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .energy-bar {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #ecf0f1;
        }

        .kinetic-energy {
            height: 100%;
            background: #e74c3c;
            width: 50%;
            transition: width 0.3s;
        }

        .potential-energy {
            height: 100%;
            background: #3498db;
            width: 50%;
            transition: width 0.3s;
        }

        .info-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .info-card {
            background: #3498db;
            color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .time-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .time-rate-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .time-rate-buttons {
            display: flex;
            gap: 10px;
        }

        .time-rate-btn {
            padding: 8px 15px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-rate-btn:hover {
            background: #27ae60;
        }

        .time-rate-btn.active {
            background: #e74c3c;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            flex: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .calculation-area {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .step {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #3498db;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .equation {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            overflow-x: auto;
        }

        .final-answer {
            background: #e8f5e9;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border-left: 5px solid #4caf50;
        }

        .final-answer h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .diagram-line {
            stroke: #e74c3c;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
        }

        .diagram-text {
            fill: #2c3e50;
            font-size: 18px;
            font-weight: bold;
        }

        .formula-text {
            fill: #2196F3;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Microsoft YaHei', 'Times New Roman', serif;
        }

        .formula-background {
            fill: rgba(255, 255, 255, 0.9);
            stroke: #2196F3;
            stroke-width: 2;
            rx: 5;
        }

        .path-marker {
            fill: #e74c3c;
            font-size: 10px;
            font-weight: bold;
        }

        .collapsible-section {
            margin-top: 20px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: background 0.3s;
        }

        .collapsible-header:hover {
            background: #e8e8e8;
        }

        .collapsible-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        .collapsible-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 1000px;
            transition: max-height 0.3s ease-in;
        }

        .preset-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preset-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .preset-btn {
            flex: 1;
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .preset-btn.active {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .simulation-area {
                min-width: 100%;
            }

            .info-panel {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>汽车上下坡问题</h1>
        <p class="subtitle">交互式物理与数学模拟</p>
    </header>

    <div class="content">
        <div class="problem-description">
            <h2>问题描述</h2>
            <p>一辆汽车在上下坡过程中，速度会发生变化：</p>
            <p>• 上坡时，速度为 \( 28 \, \text{km/h} \)</p>
            <p>• 下坡时，速度为 \( 42 \, \text{km/h} \)</p>
            <p>从甲地到乙地用了 4 小时 30 分钟，返回时用了 4 小时 40 分钟。</p>
            <p><strong>问题：</strong>从甲地到乙地的上坡路和下坡路各是多少千米？</p>


        </div>

        <div class="simulation-area">
            <div class="animation-container">
                <div class="animation-title">
                    <h2>上下坡模拟</h2>
                    <div class="energy-display">
                        <div class="energy-title">能量转换</div>
                        <div class="energy-bar-container">
                            <div class="energy-label">
                                <span>动能</span>
                                <span id="kineticPercent">50%</span>
                            </div>
                            <div class="energy-bar">
                                <div class="kinetic-energy" id="kineticEnergy"></div>
                            </div>
                        </div>
                        <div class="energy-bar-container">
                            <div class="energy-label">
                                <span>势能</span>
                                <span id="potentialPercent">50%</span>
                            </div>
                            <div class="energy-bar">
                                <div class="potential-energy" id="potentialEnergy"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hill-scene">
                    <div class="sky"></div>
                    <div class="hill-svg-container">
                        <svg class="hill-svg" viewBox="0 0 1000 200" preserveAspectRatio="none">
                            <!-- 山坡路径 -->
                            <path id="hillPath" d="M 100,200 L 500,50 L 900,200" fill="#795548" />
                            <!-- 道路路径 -->
                            <path id="roadPath" d="M 100,200 L 500,50 L 900,200" fill="#555" stroke="none" />
                            <!-- 路径标记 -->
                            <circle cx="100" cy="200" r="5" fill="#e74c3c" />
                            <circle cx="500" cy="50" r="5" fill="#e74c3c" />
                            <circle cx="900" cy="200" r="5" fill="#e74c3c" />
                            <text x="100" y="190" class="path-marker" text-anchor="middle">甲地</text>
                            <text x="500" y="40" class="path-marker" text-anchor="middle">最高点</text>
                            <text x="900" y="190" class="path-marker" text-anchor="middle">乙地</text>

                            <!-- 线段图图层 -->
                            <g id="diagramOverlay">
                                <!-- 这里将通过JavaScript添加线段 -->
                            </g>
                        </svg>
                    </div>
                    <div class="ground"></div>

                    <!-- 汽车 -->
                    <div class="car" id="car">
                        <div class="car-body"></div>
                        <div class="car-top"></div>
                        <div class="wheel front"></div>
                        <div class="wheel back"></div>
                    </div>
                </div>

                <div class="info-panel">
                    <div class="info-card">
                        <div>当前位置</div>
                        <div class="info-value" id="position">起点</div>
                    </div>
                    <div class="info-card">
                        <div>当前速度</div>
                        <div class="info-value" id="speed">0 km/h</div>
                    </div>
                    <div class="info-card">
                        <div>已用时间</div>
                        <div class="info-value" id="time">0 小时</div>
                    </div>
                    <div class="info-card">
                        <div>行驶距离</div>
                        <div class="info-value" id="distance">0 km</div>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <h2>控制面板</h2>
                <div class="buttons">
                    <button id="startBtn">开始模拟</button>
                    <button id="pauseBtn" disabled>暂停</button>
                    <button id="resetBtn">重置</button>
                    <button id="showFormulaBtn">显示数学关系</button>
                </div>

                <div class="collapsible-section">
                    <div class="preset-selector">
                        <div class="control-title">预设场景选择：</div>
                        <div class="preset-buttons">
                            <button class="preset-btn active" id="presetAtoB" data-preset="atob">甲地到乙地</button>
                            <button class="preset-btn" id="presetBtoA" data-preset="btoa">乙地到甲地</button>
                        </div>
                    </div>
                    <div class="collapsible-header" id="distanceHeader">
                        <h3>自定义参数设置</h3>
                        <span class="collapsible-icon" id="distanceIcon">▼</span>
                    </div>

                    <div class="collapsible-content" id="distanceContent">
                        <div class="controls">
                            <div class="control-group">
                                <div class="control-title">上坡速度 (km/h)</div>
                                <div class="slider-container">
                                    <input type="range" min="10" max="50" value="28" class="slider" id="uphillSpeed">
                                    <span class="slider-value" id="uphillSpeedValue">28</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <div class="control-title">下坡速度 (km/h)</div>
                                <div class="slider-container">
                                    <input type="range" min="10" max="50" value="42" class="slider" id="downhillSpeed">
                                    <span class="slider-value" id="downhillSpeedValue">42</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <div class="control-title">上坡距离 (km)</div>
                                <div class="slider-container">
                                    <input type="range" min="10" max="100" value="70" class="slider" id="uphillDistance">
                                    <span class="slider-value" id="uphillDistanceValue">70</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <div class="control-title">下坡距离 (km)</div>
                                <div class="slider-container">
                                    <input type="range" min="10" max="100" value="84" class="slider" id="downhillDistance">
                                    <span class="slider-value" id="downhillDistanceValue">84</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <div class="control-title">时间倍率</div>
                                <div class="slider-container">
                                    <input type="range" min="1" max="2000" value="2000" class="slider" id="timeRate">
                                    <span class="slider-value" id="timeRateValue">2000x</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <div class="calculation-area">
        <h2>计算过程</h2>
        <div class="step">
            <span class="step-number">1</span>
            <strong>设未知数</strong>
            <p>设从甲地到乙地的上坡路为 \( x \) 千米，下坡路为 \( y \) 千米。</p>
        </div>

        <div class="step">
            <span class="step-number">2</span>
            <strong>建立方程</strong>
            <p>从甲地到乙地：上坡时间 \( \frac{x}{28} \) 小时，下坡时间 \( \frac{y}{42} \) 小时</p>
            <div class="equation">
                \[ \frac{x}{28} + \frac{y}{42} = 4.5 \]
            </div>

            <p>从乙地到甲地：上坡时间 \( \frac{y}{28} \) 小时，下坡时间 \( \frac{x}{42} \) 小时</p>
            <div class="equation">
                \[ \frac{y}{28} + \frac{x}{42} = \frac{14}{3} \]
            </div>
        </div>

        <div class="step">
            <span class="step-number">3</span>
            <strong>解方程组</strong>
            <p>化简方程组：</p>
            <div class="equation">
                \[
                \begin{cases}
                3x + 2y = 378 \\
                2x + 3y = 392
                \end{cases}
                \]
            </div>

            <p>解得：</p>
            <div class="equation">
                \[ x = 70, \quad y = 84 \]
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取DOM元素
        const car = document.getElementById('car');
        const hillPath = document.getElementById('hillPath');
        const diagramOverlay = document.getElementById('diagramOverlay');
        const kineticEnergy = document.getElementById('kineticEnergy');
        const potentialEnergy = document.getElementById('potentialEnergy');
        const kineticPercent = document.getElementById('kineticPercent');
        const potentialPercent = document.getElementById('potentialPercent');
        const positionElement = document.getElementById('position');
        const speedElement = document.getElementById('speed');
        const timeElement = document.getElementById('time');
        const distanceElement = document.getElementById('distance');

        const uphillSpeedSlider = document.getElementById('uphillSpeed');
        const downhillSpeedSlider = document.getElementById('downhillSpeed');
        const uphillDistanceSlider = document.getElementById('uphillDistance');
        const downhillDistanceSlider = document.getElementById('downhillDistance');
        const timeRateSlider = document.getElementById('timeRate');

        const uphillSpeedValue = document.getElementById('uphillSpeedValue');
        const downhillSpeedValue = document.getElementById('downhillSpeedValue');
        const uphillDistanceValue = document.getElementById('uphillDistanceValue');
        const downhillDistanceValue = document.getElementById('downhillDistanceValue');
        const timeRateValue = document.getElementById('timeRateValue');

        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const showFormulaBtn = document.getElementById('showFormulaBtn');
        
        // 可折叠区域相关元素
        const distanceHeader = document.getElementById('distanceHeader');
        const distanceContent = document.getElementById('distanceContent');
        const distanceIcon = document.getElementById('distanceIcon');
        const presetAtoB = document.getElementById('presetAtoB');
        const presetBtoA = document.getElementById('presetBtoA');

        // 状态变量
        let animationId = null;
        let isAnimating = false;
        let isPaused = false;
        let lastTimestamp = 0;
        let currentPosition = 0; // 0-1 表示位置比例
        let currentDistance = 0; // 已行驶距离(km)
        let currentTime = 0; // 已用时间(小时)
        let timeRate = 2000; // 时间倍率，默认2000倍
        let showFormula = false; // 是否显示数学关系

        // 山坡路径参数
        const pathStartX = 100;
        const pathPeakX = 500;
        const pathEndX = 900;
        const pathStartY = 200;
        const pathPeakY = 50;
        const pathEndY = 200;

        // 更新滑块显示值
        function updateSliderValues() {
            uphillSpeedValue.textContent = uphillSpeedSlider.value;
            downhillSpeedValue.textContent = downhillSpeedSlider.value;
            uphillDistanceValue.textContent = uphillDistanceSlider.value;
            downhillDistanceValue.textContent = downhillDistanceSlider.value;
            timeRateValue.textContent = `${timeRateSlider.value}x`;
            timeRate = parseInt(timeRateSlider.value);
        }

        // 初始化滑块值
        updateSliderValues();
        
        // 设置时间倍率默认值为2000
        timeRateSlider.value = 2000;
        timeRate = 2000;
        timeRateValue.textContent = '2000x';

        // 可折叠区域展开/收起
        let isDistanceExpanded = false;
        distanceHeader.addEventListener('click', function() {
            isDistanceExpanded = !isDistanceExpanded;
            if (isDistanceExpanded) {
                distanceContent.classList.add('expanded');
                distanceIcon.textContent = '▲';
            } else {
                distanceContent.classList.remove('expanded');
                distanceIcon.textContent = '▼';
            }
        });

        // 预设按钮事件
        presetAtoB.addEventListener('click', function() {
            presetAtoB.classList.add('active');
            presetBtoA.classList.remove('active');
            // 甲到乙：上坡距离x=70，下坡距离y=84
            uphillDistanceSlider.value = 70;
            downhillDistanceSlider.value = 84;
            updateSliderValues();
            // 重置动画位置
            currentPosition = 0;
            updateCarPosition();
            if (showFormula) updateDiagram();
        });

        presetBtoA.addEventListener('click', function() {
            presetBtoA.classList.add('active');
            presetAtoB.classList.remove('active');
            // 乙到甲：上坡距离y=84（原来的下坡），下坡距离x=70（原来的上坡）
            uphillDistanceSlider.value = 84;
            downhillDistanceSlider.value = 70;
            updateSliderValues();
            // 重置动画位置（从右往左，所以位置从1开始）
            currentPosition = 1;
            updateCarPosition();
            if (showFormula) updateDiagram();
        });

        // 滑块事件监听
        uphillSpeedSlider.addEventListener('input', function() {
            updateSliderValues();
            if (showFormula) updateDiagram();
        });
        downhillSpeedSlider.addEventListener('input', function() {
            updateSliderValues();
            if (showFormula) updateDiagram();
        });
        uphillDistanceSlider.addEventListener('input', function() {
            updateSliderValues();
            if (showFormula) updateDiagram();
        });
        downhillDistanceSlider.addEventListener('input', function() {
            updateSliderValues();
            if (showFormula) updateDiagram();
        });
        timeRateSlider.addEventListener('input', function() {
            updateSliderValues();
        });

        // 显示数学关系按钮
        showFormulaBtn.addEventListener('click', function() {
            showFormula = !showFormula;
            this.textContent = showFormula ? "隐藏数学关系" : "显示数学关系";
            updateDiagram();
        });

        // 获取当前速度(基于位置)
        function getCurrentSpeed(position) {
            const totalDistance = parseFloat(uphillDistanceSlider.value) + parseFloat(downhillDistanceSlider.value);
            const uphillRatio = parseFloat(uphillDistanceSlider.value) / totalDistance;
            
            // 获取当前预设方向
            const currentPreset = document.querySelector('.preset-btn.active')?.getAttribute('data-preset') || 'atob';
            const isBtoA = currentPreset === 'btoa';
            
            let actualPosition = position;
            if (isBtoA) {
                // 从右往左：反转位置
                actualPosition = 1 - position;
            }

            if (actualPosition <= uphillRatio) {
                // 上坡段
                return parseFloat(uphillSpeedSlider.value);
            } else {
                // 下坡段
                return parseFloat(downhillSpeedSlider.value);
            }
        }

        // 更新能量条
        function updateEnergyBars(position) {
            const totalDistance = parseFloat(uphillDistanceSlider.value) + parseFloat(downhillDistanceSlider.value);
            const uphillRatio = parseFloat(uphillDistanceSlider.value) / totalDistance;
            
            // 获取当前预设方向
            const currentPreset = document.querySelector('.preset-btn.active')?.getAttribute('data-preset') || 'atob';
            const isBtoA = currentPreset === 'btoa';
            
            let actualPosition = position;
            if (isBtoA) {
                // 从右往左：反转位置
                actualPosition = 1 - position;
            }

            let kineticWidth, potentialWidth;

            if (actualPosition <= uphillRatio) {
                // 上坡段：动能减少，势能增加
                const progress = actualPosition / uphillRatio;
                kineticWidth = 100 - (70 * progress);
                potentialWidth = 30 + (70 * progress);
            } else {
                // 下坡段：动能增加，势能减少
                const progress = (actualPosition - uphillRatio) / (1 - uphillRatio);
                kineticWidth = 30 + (70 * progress);
                potentialWidth = 100 - (70 * progress);
            }

            kineticEnergy.style.width = `${kineticWidth}%`;
            potentialEnergy.style.width = `${potentialWidth}%`;

            kineticPercent.textContent = `${Math.round(kineticWidth)}%`;
            potentialPercent.textContent = `${Math.round(potentialWidth)}%`;
        }

        // 更新信息面板
        function updateInfoPanel(position, distance, time) {
            const totalDistance = parseFloat(uphillDistanceSlider.value) + parseFloat(downhillDistanceSlider.value);
            const uphillRatio = parseFloat(uphillDistanceSlider.value) / totalDistance;
            
            // 获取当前预设方向
            const currentPreset = document.querySelector('.preset-btn.active')?.getAttribute('data-preset') || 'atob';
            const isBtoA = currentPreset === 'btoa';
            
            let actualPosition = position;
            if (isBtoA) {
                // 从右往左：反转位置
                actualPosition = 1 - position;
            }

            // 更新位置
            if (position < 0.01 || position > 0.99) {
                if (isBtoA) {
                    positionElement.textContent = position < 0.01 ? "终点(甲地)" : "起点(乙地)";
                } else {
                    positionElement.textContent = position < 0.01 ? "起点(甲地)" : "终点(乙地)";
                }
            } else if (actualPosition <= uphillRatio) {
                positionElement.textContent = "上坡中";
            } else {
                positionElement.textContent = "下坡中";
            }

            // 更新速度
            speedElement.textContent = `${getCurrentSpeed(position)} km/h`;

            // 更新时间和距离
            timeElement.textContent = `${time.toFixed(2)} 小时`;
            distanceElement.textContent = `${distance.toFixed(1)} km`;
        }

        // 更新数学关系显示
        function updateDiagram() {
            // 清除现有内容
            diagramOverlay.innerHTML = '';

            if (!showFormula) return;

            const svgNS = "http://www.w3.org/2000/svg";
            const uphillDist = parseFloat(uphillDistanceSlider.value);
            const downhillDist = parseFloat(downhillDistanceSlider.value);
            const uphillSpeed = parseFloat(uphillSpeedSlider.value);
            const downhillSpeed = parseFloat(downhillSpeedSlider.value);

            // 计算上坡和下坡的时间
            const uphillTime = uphillDist / uphillSpeed;
            const downhillTime = downhillDist / downhillSpeed;
            const totalTime = uphillTime + downhillTime;

            // 根据当前预设确定方向
            const currentPreset = document.querySelector('.preset-btn.active')?.getAttribute('data-preset') || 'atob';
            const isBtoA = currentPreset === 'btoa';

            // 上坡段公式显示
            let uphillMidX, uphillMidY;
            if (isBtoA) {
                // 乙到甲：上坡在右侧（从右往左）
                uphillMidX = (pathPeakX + pathEndX) / 2;
                uphillMidY = (pathPeakY + pathEndY) / 2;
            } else {
                // 甲到乙：上坡在左侧（从左往右）
                uphillMidX = (pathStartX + pathPeakX) / 2;
                uphillMidY = (pathStartY + pathPeakY) / 2;
            }
            
            // 上坡公式背景
            const uphillBg = document.createElementNS(svgNS, "rect");
            uphillBg.setAttribute("class", "formula-background");
            uphillBg.setAttribute("x", uphillMidX - 140);
            uphillBg.setAttribute("y", uphillMidY - 35);
            uphillBg.setAttribute("width", "280");
            uphillBg.setAttribute("height", "70");
            diagramOverlay.appendChild(uphillBg);

            // 上坡公式文本
            const uphillFormula = document.createElementNS(svgNS, "text");
            uphillFormula.setAttribute("class", "formula-text");
            uphillFormula.setAttribute("x", uphillMidX);
            uphillFormula.setAttribute("y", uphillMidY - 10);
            uphillFormula.setAttribute("text-anchor", "middle");
            uphillFormula.setAttribute("font-size", "18px");
            if (isBtoA) {
                uphillFormula.textContent = `上坡时间: t₁ = y/${uphillSpeed}`;
            } else {
                uphillFormula.textContent = `上坡时间: t₁ = x/${uphillSpeed}`;
            }
            diagramOverlay.appendChild(uphillFormula);

            const uphillFormula2 = document.createElementNS(svgNS, "text");
            uphillFormula2.setAttribute("class", "formula-text");
            uphillFormula2.setAttribute("x", uphillMidX);
            uphillFormula2.setAttribute("y", uphillMidY + 15);
            uphillFormula2.setAttribute("text-anchor", "middle");
            uphillFormula2.setAttribute("font-size", "16px");
            if (isBtoA) {
                uphillFormula2.textContent = `上坡距离: y (未知)`;
            } else {
                uphillFormula2.textContent = `上坡距离: x (未知)`;
            }
            diagramOverlay.appendChild(uphillFormula2);

            // 下坡段公式显示
            let downhillMidX, downhillMidY;
            if (isBtoA) {
                // 乙到甲：下坡在左侧（从右往左）
                downhillMidX = (pathStartX + pathPeakX) / 2;
                downhillMidY = (pathStartY + pathPeakY) / 2;
            } else {
                // 甲到乙：下坡在右侧（从左往右）
                downhillMidX = (pathPeakX + pathEndX) / 2;
                downhillMidY = (pathPeakY + pathEndY) / 2;
            }
            
            // 下坡公式背景
            const downhillBg = document.createElementNS(svgNS, "rect");
            downhillBg.setAttribute("class", "formula-background");
            downhillBg.setAttribute("x", downhillMidX - 140);
            downhillBg.setAttribute("y", downhillMidY - 35);
            downhillBg.setAttribute("width", "280");
            downhillBg.setAttribute("height", "70");
            diagramOverlay.appendChild(downhillBg);

            // 下坡公式文本
            const downhillFormula = document.createElementNS(svgNS, "text");
            downhillFormula.setAttribute("class", "formula-text");
            downhillFormula.setAttribute("x", downhillMidX);
            downhillFormula.setAttribute("y", downhillMidY - 10);
            downhillFormula.setAttribute("text-anchor", "middle");
            downhillFormula.setAttribute("font-size", "18px");
            if (isBtoA) {
                downhillFormula.textContent = `下坡时间: t₂ = x/${downhillSpeed}`;
            } else {
                downhillFormula.textContent = `下坡时间: t₂ = y/${downhillSpeed}`;
            }
            diagramOverlay.appendChild(downhillFormula);

            const downhillFormula2 = document.createElementNS(svgNS, "text");
            downhillFormula2.setAttribute("class", "formula-text");
            downhillFormula2.setAttribute("x", downhillMidX);
            downhillFormula2.setAttribute("y", downhillMidY + 15);
            downhillFormula2.setAttribute("text-anchor", "middle");
            downhillFormula2.setAttribute("font-size", "16px");
            if (isBtoA) {
                downhillFormula2.textContent = `下坡距离: x (未知)`;
            } else {
                downhillFormula2.textContent = `下坡距离: y (未知)`;
            }
            diagramOverlay.appendChild(downhillFormula2);

            // 总时间公式显示在顶部
            const totalFormulaBg = document.createElementNS(svgNS, "rect");
            totalFormulaBg.setAttribute("class", "formula-background");
            totalFormulaBg.setAttribute("x", pathPeakX - 200);
            totalFormulaBg.setAttribute("y", pathPeakY - 50);
            totalFormulaBg.setAttribute("width", "400");
            totalFormulaBg.setAttribute("height", "80");
            diagramOverlay.appendChild(totalFormulaBg);

            // 根据当前预设显示不同的总时间公式
            let totalTimeFormula = '';
            let formulaY = pathPeakY - 15;
            
            if (isBtoA) {
                // 乙到甲：y/28 + x/42 = 14/3
                totalTimeFormula = `从乙到甲: t₁ + t₂ = y/${uphillSpeed} + x/${downhillSpeed} = 14/3`;
            } else {
                // 甲到乙：x/28 + y/42 = 4.5
                totalTimeFormula = `从甲到乙: t₁ + t₂ = x/${uphillSpeed} + y/${downhillSpeed} = 4.5`;
            }

            const totalFormula = document.createElementNS(svgNS, "text");
            totalFormula.setAttribute("class", "formula-text");
            totalFormula.setAttribute("x", pathPeakX);
            totalFormula.setAttribute("y", formulaY);
            totalFormula.setAttribute("text-anchor", "middle");
            totalFormula.setAttribute("font-size", "16px");
            totalFormula.textContent = totalTimeFormula;
            diagramOverlay.appendChild(totalFormula);
            
            // 添加说明文字
            const noteText = document.createElementNS(svgNS, "text");
            noteText.setAttribute("class", "formula-text");
            noteText.setAttribute("x", pathPeakX);
            noteText.setAttribute("y", formulaY + 20);
            noteText.setAttribute("text-anchor", "middle");
            noteText.setAttribute("font-size", "13px");
            noteText.setAttribute("fill", "#666");
            noteText.textContent = "注：x和y是未知数，需要通过方程组求解";
            diagramOverlay.appendChild(noteText);
        }

        // 动画函数
        function animate(timestamp) {
            if (!lastTimestamp) lastTimestamp = timestamp;

            const elapsedSeconds = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;

            if (isAnimating && !isPaused) {
                // 获取当前预设方向
                const currentPreset = document.querySelector('.preset-btn.active')?.getAttribute('data-preset') || 'atob';
                const isBtoA = currentPreset === 'btoa';
                
                // 计算当前速度
                const currentSpeed = getCurrentSpeed(currentPosition);

                // 计算移动的距离(km)，应用时间倍率
                const distanceIncrement = (currentSpeed * elapsedSeconds * timeRate) / 3600;

                // 更新位置
                const totalDistance = parseFloat(uphillDistanceSlider.value) + parseFloat(downhillDistanceSlider.value);
                
                if (isBtoA) {
                    // 从右往左：位置递减
                    currentPosition -= distanceIncrement / totalDistance;
                    if (currentPosition <= 0) {
                        currentPosition = 0;
                        isAnimating = false;
                        startBtn.disabled = false;
                        pauseBtn.disabled = true;
                        pauseBtn.textContent = "暂停";
                        isPaused = false;
                    }
                } else {
                    // 从左往右：位置递增
                    currentPosition += distanceIncrement / totalDistance;
                    if (currentPosition >= 1) {
                        currentPosition = 1;
                        isAnimating = false;
                        startBtn.disabled = false;
                        pauseBtn.disabled = true;
                        pauseBtn.textContent = "暂停";
                        isPaused = false;
                    }
                }
                
                currentDistance += distanceIncrement;
                currentTime += (elapsedSeconds * timeRate) / 3600;

                // 更新汽车位置和角度
                updateCarPosition();

                // 更新能量条
                updateEnergyBars(currentPosition);

                // 更新信息面板
                updateInfoPanel(currentPosition, currentDistance, currentTime);

                // 更新数学关系显示
                updateDiagram();
            }

            // 继续动画
            if (isAnimating) {
                animationId = requestAnimationFrame(animate);
            }
        }

        // 更新汽车位置和角度
        function updateCarPosition() {
            const hillScene = document.querySelector('.hill-scene');
            const hillWidth = hillScene.offsetWidth;
            const hillHeight = hillScene.offsetHeight;

            // 获取当前预设方向
            const currentPreset = document.querySelector('.preset-btn.active')?.getAttribute('data-preset') || 'atob';
            const isBtoA = currentPreset === 'btoa';

            // 计算当前点在路径上的位置
            const totalDistance = parseFloat(uphillDistanceSlider.value) + parseFloat(downhillDistanceSlider.value);
            const uphillRatio = parseFloat(uphillDistanceSlider.value) / totalDistance;

            let pointX, pointY;
            let actualPosition = currentPosition;

            if (isBtoA) {
                // 从右往左：反转位置
                actualPosition = 1 - currentPosition;
            }

            if (actualPosition <= uphillRatio) {
                // 上坡段
                const progress = actualPosition / uphillRatio;
                if (isBtoA) {
                    // 从右往左：从终点到起点
                    pointX = pathEndX - (pathEndX - pathPeakX) * progress;
                    pointY = pathEndY - (pathEndY - pathPeakY) * progress;
                } else {
                    // 从左往右：从起点到顶点
                    pointX = pathStartX + (pathPeakX - pathStartX) * progress;
                    pointY = pathStartY + (pathPeakY - pathStartY) * progress;
                }
            } else {
                // 下坡段
                const progress = (actualPosition - uphillRatio) / (1 - uphillRatio);
                if (isBtoA) {
                    // 从右往左：从顶点到起点
                    pointX = pathPeakX - (pathPeakX - pathStartX) * progress;
                    pointY = pathPeakY - (pathPeakY - pathStartY) * progress;
                } else {
                    // 从左往右：从顶点到终点
                    pointX = pathPeakX + (pathEndX - pathPeakX) * progress;
                    pointY = pathPeakY + (pathEndY - pathPeakY) * progress;
                }
            }

            // 计算斜率/角度
            let slope, angle;

            if (actualPosition <= uphillRatio) {
                // 上坡段
                if (isBtoA) {
                    // 从右往左：计算从终点到顶点的斜率（方向相反）
                    slope = (pathPeakY - pathEndY) / (pathPeakX - pathEndX);
                } else {
                    slope = (pathPeakY - pathStartY) / (pathPeakX - pathStartX);
                }
            } else {
                // 下坡段
                if (isBtoA) {
                    // 从右往左：计算从顶点到起点的斜率（方向相反）
                    slope = (pathStartY - pathPeakY) / (pathStartX - pathPeakX);
                } else {
                    slope = (pathEndY - pathPeakY) / (pathEndX - pathPeakX);
                }
            }

            angle = Math.atan(slope) * 180 / Math.PI;
            
            // 从右往左时，水平翻转汽车，而不是旋转180度
            let transform = `rotate(${angle}deg)`;
            if (isBtoA) {
                transform += ` scaleX(-1)`;
            }

            // 更新汽车位置和旋转
            // 将SVG坐标转换为像素坐标
            const carX = (pointX / 1000) * hillWidth - 40; // 减去汽车宽度的一半使其居中
            const carY = (pointY / 200) * (hillHeight * 0.7) - 20; // 调整Y坐标计算

            car.style.left = `${carX}px`;
            car.style.top = `${carY}px`;
            car.style.transform = transform;
        }

// 初始化汽车位置
        function initializeCarPosition() {
            const hillScene = document.querySelector('.hill-scene');
            const hillWidth = hillScene.offsetWidth;
            const hillHeight = hillScene.offsetHeight;

            // 设置初始位置在起点
            const startX = (pathStartX / 1000) * hillWidth - 40;
            const startY = (pathStartY / 200) * (hillHeight * 0.7) - 20;

            car.style.left = `${startX}px`;
            car.style.top = `${startY}px`;
            car.style.transform = 'rotate(0deg)';
        }

        // 开始动画
        startBtn.addEventListener('click', function() {
            if (!isAnimating) {
                isAnimating = true;
                isPaused = false;
                lastTimestamp = 0;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                animationId = requestAnimationFrame(animate);
            }
        });

        // 暂停/继续动画
        pauseBtn.addEventListener('click', function() {
            if (isAnimating) {
                if (isPaused) {
                    // 继续动画
                    isPaused = false;
                    pauseBtn.textContent = "暂停";
                    lastTimestamp = 0;
                    animationId = requestAnimationFrame(animate);
                } else {
                    // 暂停动画
                    isPaused = true;
                    pauseBtn.textContent = "继续";
                }
            }
        });

        // 重置动画
        resetBtn.addEventListener('click', function() {
            isAnimating = false;
            isPaused = false;
            currentDistance = 0;
            currentTime = 0;

            // 根据当前预设设置初始位置
            const currentPreset = document.querySelector('.preset-btn.active')?.getAttribute('data-preset') || 'atob';
            if (currentPreset === 'btoa') {
                currentPosition = 1; // 从右往左，从1开始
            } else {
                currentPosition = 0; // 从左往右，从0开始
            }

            cancelAnimationFrame(animationId);

            // 重置汽车位置
            updateCarPosition();

            // 重置能量条
            updateEnergyBars(currentPosition);

            // 重置信息面板
            updateInfoPanel(currentPosition, 0, 0);

            // 更新数学关系显示
            updateDiagram();

            // 重置按钮状态
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            pauseBtn.textContent = "暂停";
        });

        // 初始化能量条和信息面板
        updateEnergyBars(0);
        updateInfoPanel(0, 0, 0);
        updateCarPosition();
        updateDiagram();

        // 渲染数学公式
        if (typeof renderMathInElement !== 'undefined') {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ]
            });
        }
    });
</script>
</body>
</html>